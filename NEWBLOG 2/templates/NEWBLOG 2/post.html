{% extends "layout.html" %}
{% set page_title="My Blog" %}
{% from "macros.html" import blog_post %}



{% block content %}
  {{ blog_post(post, True) }}

  {% if post['Latitude'] and post['Longitude'] %}
    <hr class="my-4">

    <h5 class="mb-1">Location</h5>
    {% if post['Address'] %}
      <p class="text-muted mb-2">{{ post['Address'] }}</p>
    {% endif %}

    <!-- Map container keeps data in attributes so JS is linter-friendly -->
    <div id="post-map"
         data-lat="{{ post['Latitude'] }}"
         data-lng="{{ post['Longitude'] }}"
         data-address="{{ (post['Address'] or '') | e }}"
         style="height: 360px; border-radius: 8px; background: #f5f5f5;"></div>

    <div class="mt-2">
      <a class="btn btn-outline-secondary btn-sm"
         href="https://maps.google.com/?q={{ post['Latitude'] }},{{ post['Longitude'] }}"
         target="_blank" rel="noopener">
        Open in Maps
      </a>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const el = document.getElementById('post-map');
        if (!el) return;

        // Read coords from data- attributes
        const lat = parseFloat(el.dataset.lat);
        const lng = parseFloat(el.dataset.lng);
        const addr = el.dataset.address || 'Selected location';

        // Quick diagnostics in the console
        console.debug('Post map coords:', { lat, lng, addr });

        if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
          console.warn('Post has no valid coordinates; not rendering map.');
          return;
        }

        if (typeof L === 'undefined' || !L.map) {
          console.error('Leaflet is not loaded. Check layout.html includes Leaflet CSS/JS.');
          return;
        }

        // Create the map
        const map = L.map('post-map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        map.setView([lat, lng], 15);
        const marker = L.marker([lat, lng]).addTo(map);
        if (addr) marker.bindPopup(addr);

        // In case the container was sized after render (Bootstrap/layout), fix tiles
        setTimeout(() => map.invalidateSize(), 0);
      });
    </script>
  {% else %}
    <!-- Optional: show a gentle note when there are no coordinates -->
    <hr class="my-4">
    <div class="text-muted small">No location saved for this post.</div>
  {% endif %}
{% endblock %}
