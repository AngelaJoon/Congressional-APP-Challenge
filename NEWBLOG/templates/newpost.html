{% extends "layout.html" %}

{% set page_title="New Post" %}

{% block heading %}
<div class="header-container">
  <h1>Paw Point</h1>
</div>
{% endblock %}

{% block content %}
<div class="container p-3 mt-5 rounded bg-white">
  <form action="{{actionRoute}}" method="POST" enctype="multipart/form-data">
    <input type="hidden" id="post-content" name="post-content">
    {% if update %}
      <input type="hidden" name="post-permalink" value="{{post_data['permalink']}}">
      <input type="hidden" name="post-date" value="{{post_data['published_on']}}">
      <input type="hidden" name="post-id" value="{{post_data['PostId']}}">
    {% endif %}

    <div class="mb-3">
      <label>Title of Your Post</label>
      <input type="text" placeholder="Title of your post" name="post-title" class="form-control" value="{{post_data['title']}}">
    </div>

    <style>
      /* Base pill styling */
      .rating-label {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 9999px;
        border: 2px solid transparent;
        font-weight: 600;
        cursor: pointer;
        user-select: none;
        transition: background .15s ease, color .15s ease, border-color .15s ease, box-shadow .15s ease;
      }
      /* Hide the native radios (label does the work) */
      .rating-input { position: absolute; opacity: 0; pointer-events: none; }
      /* Default/light tint */
      .rating-input + .rating-label { background: var(--bg, #eee); color: var(--text, #111); }
      .rating-input + .rating-label:hover { background: var(--bg-hover, var(--bg)); }
      /* Selected */
      .rating-input:checked + .rating-label {
        background: var(--bg-active); color: var(--text-active, #fff);
        border-color: var(--border-active, transparent);
        box-shadow: 0 0 0 2px rgba(0,0,0,.06) inset;
      }
      .rating-input:focus-visible + .rating-label { outline: 3px solid #333; outline-offset: 2px; }
      /* Colors */
      #very_safe + label { --bg:#e6f6ea; --bg-hover:#d3f0db; --bg-active:#2e7d32; --text:#1b5e20; --text-active:#fff; }
      #safe + label { --bg:#e9fbe9; --bg-hover:#d9f6d9; --bg-active:#66bb6a; --text:#2e7d32; --text-active:#fff; }
      #unclear + label { --bg:#fff7cc; --bg-hover:#ffef99; --bg-active:#fbc02d; --text:#7a5d00; --text-active:#000; }
      #dangerous + label { --bg:#ffe2cc; --bg-hover:#ffcfaa; --bg-active:#f57c00; --text:#7a2e00; --text-active:#fff; }
      #very_dangerous + label { --bg:#ffd6d6; --bg-hover:#ffb3b3; --bg-active:#d32f2f; --text:#7a0000; --text-active:#fff; }
      .rating-row { margin: 6px 0; }
    </style>

    <div class="mb-3">
      <label>Shelter Strain Index</label>
      <div class="rating-row">
        <input class="rating-input" type="radio" id="very_safe" name="rating" value="Very Safe"
               {% if post_data['rating'] == 'Very Safe' %}checked{% endif %}>
        <label class="rating-label" for="very_safe">Very Safe</label>
      </div>
      <div class="rating-row">
        <input class="rating-input" type="radio" id="safe" name="rating" value="Safe"
               {% if post_data['rating'] == 'Safe' %}checked{% endif %}>
        <label class="rating-label" for="safe">Safe</label>
      </div>
      <div class="rating-row">
        <input class="rating-input" type="radio" id="unclear" name="rating" value="Unclear"
               {% if post_data['rating'] == 'Unclear' or not post_data['rating'] %}checked{% endif %}>
        <label class="rating-label" for="unclear">Unclear</label>
      </div>
      <div class="rating-row">
        <input class="rating-input" type="radio" id="dangerous" name="rating" value="Dangerous"
               {% if post_data['rating'] == 'Dangerous' %}checked{% endif %}>
        <label class="rating-label" for="dangerous">Dangerous</label>
      </div>
      <div class="rating-row">
        <input class="rating-input" type="radio" id="very_dangerous" name="rating" value="Very Dangerous"
               {% if post_data['rating'] == 'Very Dangerous' %}checked{% endif %}>
        <label class="rating-label" for="very_dangerous">Very Dangerous</label>
      </div>
    </div>

    <!-- TAGS -->
    <div class="mb-3">
      <label>Tags</label>
      <input type="text" placeholder="Post tags" name="post-tags" class="form-control" value="{{post_data['tags']}}">
    </div>

    <!-- IMAGE UPLOAD -->
    <div class="mb-3">
      <label>Image</label>
      {% if 'image' in post_data and post_data['image'] %}
        <div class="mb-2">
          <img src="{{ post_data['image'] }}" alt="Post Image" width="300">
          <input type="hidden" name="existing-image" value="{{ post_data['image'] }}">
        </div>
      {% endif %}
      <input type="file" name="image" accept="image/*">
    </div>

    <!-- AUTHOR -->
    <div class="mb-3">
      <label>Post Author</label>
      <input type="text" placeholder="Author name" name="post-author" class="form-control" value="{{post_data['author']}}">
    </div>

    <!-- ADDRESS + MAP (Step 4) -->
    <div class="mb-3">
      <label>Address (Shelter Location)</label>
      <div class="input-group">
        <input
          type="text"
          name="address"
          id="address"
          class="form-control"
          placeholder="123 Main St, City, State"
          value="{{ (post_data.get('Address') or post_data.get('address') or '') }}"
        >
        <button type="button" id="lookup" class="btn btn-outline-secondary">Find on Map</button>
      </div>
      <input type="hidden" name="latitude" id="latitude" value="{{ (post_data.get('Latitude') or post_data.get('latitude') or '') }}">
      <input type="hidden" name="longitude" id="longitude" value="{{ (post_data.get('Longitude') or post_data.get('longitude') or '') }}">
    </div>

    <div class="mb-3">
      <label>Location Preview</label>
      <div id="map" style="height: 320px; border-radius: 8px;"></div>
    </div>

    <!-- CONTENT (Quill) -->
    <div id="editor">
      {% autoescape false %}
        {{post_data['content']}}
      {% endautoescape %}
    </div>

    <button type="submit" class="btn btn-secondary mt-3">
      {% if update %}Update{% else %}Publish{% endif %}
    </button>
  </form>
</div>

<!-- Quill -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
  // --- Quill init ---
  var quill = new Quill('#editor', { theme: 'snow' });
  function getEditorContent() {
    var postContent = document.querySelector('.ql-editor').innerHTML;
    document.getElementById('post-content').value = postContent;
  }
  document.querySelector('form').addEventListener('submit', getEditorContent);

  // --- Leaflet map + geocoding ---
  const map = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let marker = null;
  function setMap(lat, lng, label) {
    const ll = [lat, lng];
    if (!map._loaded) {
      map.setView(ll, 15);
    } else {
      map.panTo(ll);
    }
    if (marker) marker.remove();
    marker = L.marker(ll).addTo(map);
    if (label) marker.bindPopup(label).openPopup();
  }

  // If editing and coords exist, center map there; else show a neutral default
  (function boot() {
    const latVal = document.getElementById('latitude').value;
    const lngVal = document.getElementById('longitude').value;
    const lat = parseFloat(latVal);
    const lng = parseFloat(lngVal);
    const addr = document.getElementById('address').value;
    if (!isNaN(lat) && !isNaN(lng)) {
      setMap(lat, lng, addr || 'Selected location');
    } else {
      map.setView([37.773972, -122.431297], 11); // default view (SF)
    }
  })();

  // Geocode via your Flask proxy /geocode
  document.getElementById('lookup').addEventListener('click', async () => {
    const q = document.getElementById('address').value.trim();
    if (!q) { alert('Please enter an address first.'); return; }
    try {
      const res = await fetch(`/geocode?q=${encodeURIComponent(q)}`);
      const data = await res.json();
      if (!res.ok || data.error) {
        alert('No results found for that address.');
        return;
      }
      document.getElementById('latitude').value = data.lat;
      document.getElementById('longitude').value = data.lng;
      document.getElementById('address').value = data.address || q;
      setMap(data.lat, data.lng, data.address || 'Selected location');
    } catch (e) {
      alert('Geocoding failed. Try again.');
    }
  });
</script>
{% endblock %}
